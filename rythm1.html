<!doctype html>
<html lang="en-US" direction="ltr">
<head>
	<meta charset="utf-8" />
	<title>First rythms</title>
	<link rel="stylesheet" href="reset.css">
	<link rel="stylesheet" href="style.css">
	<script src="jquery.js" ></script>
</head>
<body>

	<div class="keys">

		<div class="key"></div>
		<div class="key black b0"></div>
		<div class="key"></div>

		<div class="key"></div>
		<div class="key black b1"></div>
		<div class="key"></div>
		<div class="key black b2"></div>
		<div class="key"></div>
		<div class="key"></div>
		<div class="key black b3"></div>
		<div class="key"></div>
		<div class="key black b4"></div>
		<div class="key"></div>
		<div class="key black b5"></div>
		<div class="key"></div>

		<div class="key"></div>
		<div class="key black b6"></div>
		<div class="key"></div>
		<div class="key black b7"></div>
		<div class="key"></div>
		<div class="key"></div>
		<div class="key black b8"></div>
		<div class="key"></div>
		<div class="key black b9"></div>
		<div class="key"></div>
		<div class="key black b10"></div>
		<div class="key"></div>

		<div class="key"></div>
		<div class="key black b11"></div>
		<div class="key"></div>
		<div class="key black b12"></div>
		<div class="key"></div>
		<div class="key"></div>
		<div class="key black b13"></div>
		<div class="key"></div>
		<div class="key black b14"></div>
		<div class="key"></div>
		<div class="key black b15"></div>
		<div class="key"></div>

		<div class="key"></div>
		<div class="key black b16"></div>
		<div class="key"></div>
		<div class="key black b17"></div>
		<div class="key"></div>
		<div class="key"></div>
		<div class="key black b18"></div>
		<div class="key"></div>
		<div class="key black b19"></div>
		<div class="key"></div>
		<div class="key black b20"></div>
		<div class="key"></div>

		<div class="key"></div>
		<div class="key black b21"></div>
		<div class="key"></div>
		<div class="key black b22"></div>
		<div class="key"></div>
		<div class="key"></div>
		<div class="key black b23"></div>
		<div class="key"></div>
		<div class="key black b24"></div>
		<div class="key"></div>
		<div class="key black b25"></div>
		<div class="key"></div>

		<div class="key"></div>
		<div class="key black b26"></div>
		<div class="key"></div>
		<div class="key black b27"></div>
		<div class="key"></div>
		<div class="key"></div>
		<div class="key black b28"></div>
		<div class="key"></div>
		<div class="key black b29"></div>
		<div class="key"></div>
		<div class="key black b30"></div>
		<div class="key"></div>

		<div class="key"></div>
		<div class="key black b31"></div>
		<div class="key"></div>
		<div class="key black b32"></div>
		<div class="key"></div>
		<div class="key"></div>
		<div class="key black b33"></div>
		<div class="key"></div>
		<div class="key black b34"></div>
		<div class="key"></div>
		<div class="key black b35"></div>
		<div class="key"></div>
		<div class="key"></div>

		<div class="clear"></div>
	</div>
	<p onclick="animateKeys(2,2000);">Run</p>
	<div class="control">
		<div class="play"></div>
	</div>
	<script>
		var songNotesR=[];
		var songRhythmR=[];
		var songNotesL=[];
		var songRhythmL=[];
		songNotesR=[88,44,48,44,51,44,56,55,53,51,53,51,49,48,49,48,46,88,48,51,48,56,51,60,63,61,63,60,63,61,63,60,63,61,63,56,60,58,60,56,60,58,60,56,60,58,60,53,56,55,56,53,56,55,56,53,56,55,56,50];
		songRhythmR=[0,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.125,0.125,0.125,0.125,0.125,0.125,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.125,0.125,0.125,0.125,0.125,0.125,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.125,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.125,0.0625,0.0625,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.25,0.625,0.125,0.125,0.125,0.125,0.125,0.125,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.125,0.125,0.125,0.125,0.125,0.125,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.125,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.125,0.0625,0.0625,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.5];

		songNotesL=[88,32,36,32,39,32,44,43,41,39,41,39,37,36,37,36,34,32,36,39,36,44,39,48,51,49,51,48,51,49,51,48,51,49,51,44,48,46,48,44,48,46,48,44,48,46,48,41,44,43,44,41,44,43,44,41,44,43,44,38,34,39,34,43,39,44,46,44,43,41,43,41,39,38,39,38,36,34,39,38,36,38,36,34,32,34,32,31,29,31,29,27,34,32,31,32,34,22,88,27,31,27,34,27,39,38,36,34,36,34,32,31,32,31,29,27,31,34,31,39,34,42,33,42,33,42,33,34,32,30,29,30,29,27,25,27,25,24,22,34,37,34,41,34,46,44,42,41,42,41,39,37,39,37,36,34,32,34,43,34,43,32,43,34,43,31,43,32,31,32,41,32,41,31,41,32,41,29,41,37,34,31,34,27,31,36,32,29,32,26,29,34,31,28,31,24,28,17,29,27,29,22,29,24,29,25,29,22,29,15,27,25,27,20,27,22,27,24,27,20,27,25,29,32,29,37,32,41,44,42,44,41,44,42,44,41,44,42,44,37,41,39,41,37,41,39,41,37,41,39,41,34,37,36,37,34,37,36,37,34,37,36,37,31,27,32,27,36,32,37,39,37,36,34,36,34,32,31,32,31,29,27,32,31,29,31,29,27,25,27,25,24,22,24,22,20,27,25,24,25,27,15,20];
		songRhythmL=[0,0.875,0.125,0.125,0.125,0.125,0.125,0.125,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.125,0.125,0.125,0.125,0.125,0.125,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.125,0.125,0.125,0.125,0.125,0.125,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.125,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.125,0.125,0.125,0.125,0.125,0.125,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.125,0.125,0.125,0.125,0.125,0.125,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.125,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.125,0.125,0.5];

		

		var context;
		var bufferLoader;
		var timeR = 0;
		var timeL = 0;
		var zarb = 60/0.25;
		var tempo = 40;

		var ratio = zarb/tempo;

		var keys = $('.keys').find('.key');
		var prev=-2;


		function BufferLoader(context, urlList, callback) {
		    this.context = context;
		    this.urlList = urlList;
		    this.onload = callback;
		    this.bufferList = new Array();
		    this.loadCount = 0;
		}

		BufferLoader.prototype.loadBuffer = function(url, index) {
		    var request = new XMLHttpRequest();
		    request.open("GET", url, true);
		    request.responseType = "arraybuffer";

		    var loader = this;

		    request.onload = function() {
		        loader.context.decodeAudioData(
		            request.response,
		            function(buffer) {
		                if (!buffer) {
		                    alert('error decoding file data: ' + url);
		                    return;
		                }
		                loader.bufferList[index] = buffer;
		                if (++loader.loadCount == loader.urlList.length)
		                    loader.onload(loader.bufferList);
		            }    
		        );
		    }

		    request.onerror = function() {
		        alert('BufferLoader: XHR error');        
		    }

		    request.send();
		}

		BufferLoader.prototype.load = function() {
		    for (var i = 0; i < this.urlList.length; ++i)
		        this.loadBuffer(this.urlList[i], i);
		}   



		function init() {
		    try {
		        context = new AudioContext();
		    }
		    catch(e) {
		        alert("Web Audio API is not supported in this browser");
		    }
		    
		    // Start loading the drum kit.
		    bufferLoader = new BufferLoader(
		        context,
		        [
					'../piano/sound/A0.mp3',
					'../piano/sound/Bb0.mp3',
					'../piano/sound/B0.mp3',

					'../piano/sound/C1.mp3',
					'../piano/sound/Db1.mp3',
					'../piano/sound/D1.mp3',
					'../piano/sound/Eb1.mp3',
					'../piano/sound/E1.mp3',
					'../piano/sound/F1.mp3',
					'../piano/sound/Gb1.mp3',
					'../piano/sound/G1.mp3',
					'../piano/sound/Ab1.mp3',
					'../piano/sound/A1.mp3',
					'../piano/sound/Bb1.mp3',
					'../piano/sound/B1.mp3',

					'../piano/sound/C2.mp3',
					'../piano/sound/Db2.mp3',
					'../piano/sound/D2.mp3',
					'../piano/sound/Eb2.mp3',
					'../piano/sound/E2.mp3',
					'../piano/sound/F2.mp3',
					'../piano/sound/Gb2.mp3',
					'../piano/sound/G2.mp3',
					'../piano/sound/Ab2.mp3',
					'../piano/sound/A2.mp3',
					'../piano/sound/Bb2.mp3',
					'../piano/sound/B2.mp3',

					'../piano/sound/C3.mp3',
					'../piano/sound/Db3.mp3',
					'../piano/sound/D3.mp3',
					'../piano/sound/Eb3.mp3',
					'../piano/sound/E3.mp3',
					'../piano/sound/F3.mp3',
					'../piano/sound/Gb3.mp3',
					'../piano/sound/G3.mp3',
					'../piano/sound/Ab3.mp3',
					'../piano/sound/A3.mp3',
					'../piano/sound/Bb3.mp3',
					'../piano/sound/B3.mp3',

					'../piano/sound/C4.mp3',
					'../piano/sound/Db4.mp3',
					'../piano/sound/D4.mp3',
					'../piano/sound/Eb4.mp3',
					'../piano/sound/E4.mp3',
					'../piano/sound/F4.mp3',
					'../piano/sound/Gb4.mp3',
					'../piano/sound/G4.mp3',
					'../piano/sound/Ab4.mp3',
					'../piano/sound/A4.mp3',
					'../piano/sound/Bb4.mp3',
					'../piano/sound/B4.mp3',

					'../piano/sound/C5.mp3',
					'../piano/sound/Db5.mp3',
					'../piano/sound/D5.mp3',
					'../piano/sound/Eb5.mp3',
					'../piano/sound/E5.mp3',
					'../piano/sound/F5.mp3',
					'../piano/sound/Gb5.mp3',
					'../piano/sound/G5.mp3',
					'../piano/sound/Ab5.mp3',
					'../piano/sound/A5.mp3',
					'../piano/sound/Bb5.mp3',
					'../piano/sound/B5.mp3',

					'../piano/sound/C6.mp3',
					'../piano/sound/Db6.mp3',
					'../piano/sound/D6.mp3',
					'../piano/sound/Eb6.mp3',
					'../piano/sound/E6.mp3',
					'../piano/sound/F6.mp3',
					'../piano/sound/Gb6.mp3',
					'../piano/sound/G6.mp3',
					'../piano/sound/Ab6.mp3',
					'../piano/sound/A6.mp3',
					'../piano/sound/Bb6.mp3',
					'../piano/sound/B6.mp3',

					'../piano/sound/C7.mp3',
					'../piano/sound/Db7.mp3',
					'../piano/sound/D7.mp3',
					'../piano/sound/Eb7.mp3',
					'../piano/sound/E7.mp3',
					'../piano/sound/F7.mp3',
					'../piano/sound/Gb7.mp3',
					'../piano/sound/G7.mp3',
					'../piano/sound/Ab7.mp3',
					'../piano/sound/A7.mp3',
					'../piano/sound/Bb7.mp3',
					'../piano/sound/B7.mp3',

					'../piano/sound/C8.mp3',

					 '../piano/sound/silence.wav',
		        ],
		        bufferLoadCompleted  
		    );

		    bufferLoader.load();
		}

		init();
		var startTime = context.currentTime + 0.100;

		function bufferLoadCompleted (){
			var audios = bufferLoader.bufferList;
			keys.each(function(){
				$(this).click(function(){
					var keyIndex = $(this).index();
					playsong(audios[keyIndex],startTime);
				})
			})	
		}

		function playsong (buffer, time,key){
			var source = context.createBufferSource();
			source.buffer = buffer;
			var gain = context.createGain();
			gain.gain.value = 0.5;
			source.connect(gain);
			gain.connect(context.destination);
	
			source.start(time,0,1);
			// setTimeout(function () {
			// 	keys.eq(key).addClass('active');

			// },time*1000-0.100)
			// source.onended = function(){
			// 	keys.eq(key).removeClass('active');
			// }
		}

		function playrythm (bufferList){
			animateKeys(songNotesR,1,songRhythmR);
			animateKeys(songNotesL,1,songRhythmL);

			for(j=1;j<songNotesR.length ;j++){

				timeR += songRhythmR[j];
				timeL += songRhythmL[j];
				playsong(bufferList[ songNotesR[j] ],timeR*ratio, songNotesR[j]);
				playsong(bufferList[ songNotesL[j] ],timeL*ratio, songNotesL[j]);
			}
		}

		function animateKeys (array,i,time){

			setTimeout(function(){
				keys.eq(array[i]).addClass('active');
				removeAnimate(array,i,time);

				i++;

				if(i<array.length)
					animateKeys(array,i,time);

			},time[i]*1000*ratio)
		}

		function removeAnimate (array,i,time){

			setTimeout(function(){
				keys.eq(array[i]).removeClass('active');
			},time[i]*1000*ratio)
		}

		$('.play').click(function(){
			playrythm(bufferLoader.bufferList);
		})

	</script>
</body>
</html>