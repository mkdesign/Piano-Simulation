<!doctype html>
<html lang="en-US" direction="ltr">
<head>
	<meta charset="utf-8" />
	<title>First rythms</title>
	<link rel="stylesheet" href="reset.css">
	<!-- <link rel="stylesheet" href="style.css"> -->
	<script src="jquery.js" ></script>
	<script src="vexflow/releases/vexflow-min.js"></script>
	<script src="raphael-min.js"></script>
	<script type="text/javascript">
		$(function () {

			var canvasTag = $('canvas')[0];

			/****************************** Composer Class  ****************************/
			var composerClass = function(canvastag,userNote,userOctave,userNoteDuration){

				this.canvastag        = canvastag;
				this.renderer         = new Vex.Flow.Renderer(this.canvastag , Vex.Flow.Renderer.Backends.CANVAS);
				this.ctx              = this.renderer.getContext();
				this.stave            = new Vex.Flow.Stave(10,0,500);
				this.notes            = [];
				this.userNote         = userNote;
				this.userOctave       = userOctave;
				this.userNoteDuration = userNoteDuration;
				this.notesPositions   = [];
				this.clickedNote      = undefined;
				this.stave.addClef("treble");
			}

			composerClass.prototype.generateStave = function() {
				this.ctx.clear(); // first clear the context otherwise previouse notes will copy agin
				this.stave.setContext(this.ctx).draw();
			};

			composerClass.prototype.generateNotes = function() {
				
				Vex.Flow.Formatter.FormatAndDraw(this.ctx, this.stave, this.notes);
			};

			composerClass.prototype.addNotes = function(){
				this.notes.push(new Vex.Flow.StaveNote({

					keys: [ this.userNote.val() +"/"+ this.userOctave.val() ],
					duration: this.userNoteDuration.val() 
				}));
			}

			composerClass.prototype.editNote = function(){
				this.notes[this.clickedNote] = new Vex.Flow.StaveNote({
					keys: [ this.userNote.val() +"/"+ this.userOctave.val() ],
					duration: this.userNoteDuration.val() 
				})
			}

			composerClass.prototype.generatePositions = function() {
				for(var i=0; i<this.notes.length; i++) {
					this.notesPositions[i] = this.notes[i].getAbsoluteX();
				}
		
			};

			composerClass.prototype.findSelectedNote = function(click_position) {

				for(var i=0; i< this.notesPositions.length; i++) {

					if( click_position < this.notesPositions[i] && click_position > this.notesPositions[i-1]) {
						if( click_position <= ( this.notesPositions[i-1] + ((this.notesPositions[i]-this.notesPositions[i-1])/2))) {
							this.clickedNote = i-1;
						}
						else {
							this.clickedNote = i;
						}
					}
				}

				return this.clickedNote;
			};

			composerClass.prototype.highlighter = function(index) {
				var position = this.notesPositions[index];
				this.ctx.fillStyle = "#ff0000";
			 	this.ctx.fillRect(position-10, 40, 4, 40);
			 	this.ctx.fillStyle = "#000";
			};

			/**************************  Composer Class End  *****************************/

			var pianoComposer = new composerClass(canvasTag,$('#notes'),$('#octaves'),$('#duration'));

			document.ready = function(){
				pianoComposer.generateStave();
			}

			$('#add_note').click(function(){
				pianoComposer.generateStave();
				pianoComposer.addNotes();
				pianoComposer.generateNotes();
				pianoComposer.generatePositions();
			})

			$('#edit_note').click(function(){
				pianoComposer.generateStave();
				pianoComposer.editNote();
				pianoComposer.generateNotes();
				pianoComposer.generatePositions();
			})


			$('canvas').click(function(){
				var highlighterPosition = pianoComposer.findSelectedNote(event.clientX);
				console.log(highlighterPosition);
				pianoComposer.generateStave();
				pianoComposer.generateNotes();
				pianoComposer.highlighter(highlighterPosition)
			})
		})

	</script>
</head>
<body>
	<div class="stave">
		<canvas width="700" height="400"></canvas>
	</div>
	<div class="notation">
		<div class="choose_note">
			<label>Choose Note :</label>
			<select id="notes">
				<option selected="selected">A</option>
				<option>B</option>
				<option>C</option>
				<option>D</option>
				<option>E</option>
				<option>F</option>
				<option>G</option>
			</select>
		</div>
		<div class="choose_octave">
			<label>Choose Octave :</label>
			<select id="octaves">
				<option selected="selected">1</option>
				<option>2</option>
				<option>3</option>
				<option>4</option>
				<option>5</option>
			</select>
		</div>
		<div class="choose_duration">
			<label>Choose Duration : </label>
			<select id="duration">
				<option selected="selected"  value="w">Whole</option>
				<option value="h">Half</option>
				<option value="q">Quarter</option>
				<option value="8d">Eighth</option>
				<option value="16">Sixteenth</option>
			</select>
		</div>
		<input type="button" value="Add Note" id="add_note">
		<button id="edit_note">edit</button>
	</div>
</body>
</html>